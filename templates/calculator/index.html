{% extends "base.html" %}

{% block title %}Kostenkalkulator{% endblock %}

{% block content %}
<div class="main-header">
    <h1><i class="bi bi-calculator-fill"></i> Kostenkalkulator</h1>
</div>

<form method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <div class="card">
        <div class="card-body">
            <div class="row g-4">
                <!-- Basisdaten -->
                <div class="col-md-4">
                    <h5>1. Basisdaten</h5>
                    <hr>
                    <div class="mb-3">
                        <label for="gcode_file_id" class="form-label">G-Code-Datei</label>
                        <select name="gcode_file_id" id="gcode_file_id" class="form-select" required>
                            <option value="">Bitte auswählen...</option>
                            {% for gcode in gcode_files %}
                                <option value="{{ gcode.id }}">
                                    {{ gcode.filename }} 
                                    ({{ gcode.estimated_print_time_min or '?' }} min, {{ gcode.material_needed_g or '?' }}g)
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="material_id" class="form-label">Material</label>
                        <!-- HIER DIE ANPASSUNG: Durch FilamentType iterieren -->
                        <select name="material_id" id="material_id" class="form-select" required>
                            <option value="">Bitte auswählen...</option>
                            {% for material in materials %}
                                <option value="{{ material.id }}">
                                    {{ material.manufacturer }} - {{ material.name }} ({{ material.material_type }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="printer_id" class="form-label">Drucker</label>
                        <select name="printer_id" id="printer_id" class="form-select" required>
                            <option value="">Bitte auswählen...</option>
                            {% for printer in printers %}
                                <option value="{{ printer.id }}">
                                    {{ printer.name }} 
                                    ({% if printer.calculated_cost_per_hour %}{{ "%.2f"|format(printer.calculated_cost_per_hour) }} €/h{% else %}? €/h{% endif %})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Personalkosten -->
                <div class="col-md-4">
                    <h5>2. Personalkosten</h5>
                    <hr>
                    <div class="mb-3">
                        <label for="preparation_time_min" class="form-label">Vorbereitungszeit (Minuten)</label>
                        <input type="number" name="preparation_time_min" id="preparation_time_min" class="form-control" value="15">
                    </div>
                    <div class="mb-3">
                        <label for="post_processing_time_min" class="form-label">Nachbearbeitungszeit (Minuten)</label>
                        <input type="number" name="post_processing_time_min" id="post_processing_time_min" class="form-control" value="30">
                    </div>
                    <div class="mb-3">
                        <label for="employee_hourly_rate" class="form-label">Mitarbeiter-Stundensatz (€)</label>
                        <input type="number" step="0.01" name="employee_hourly_rate" id="employee_hourly_rate" class="form-control" value="45.00">
                    </div>
                </div>

                <!-- Preisgestaltung -->
                <div class="col-md-4">
                    <h5>3. Preisgestaltung</h5>
                    <hr>
                    <div class="mb-3">
                        <label for="margin_percent" class="form-label">Gewinnmarge (%)</label>
                        <input type="number" step="1" name="margin_percent" id="margin_percent" class="form-control" value="20">
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer text-end">
            <button type="submit" class="btn btn-primary btn-lg"><i class="bi bi-play-circle-fill"></i> Jetzt berechnen</button>
        </div>
    </div>
</form>
{% endblock %}