{% extends "base.html" %}

{% block title %}Abhängigkeiten für {{ job.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-project-diagram me-2"></i>Abhängigkeiten für Job: <strong>{{ job.name }}</strong>
                    </h4>
                    <a href="{{ url_for('jobs_bp.job_details', job_id=job.id) }}" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Zurück zu den Details
                    </a>
                </div>
                <div class="card-body">
                    <div class="card mb-4">
                        <div class="card-header">
                            Neue Abhängigkeit hinzufügen
                        </div>
                        <div class="card-body">
                            <form id="add-dependency-form">
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-6">
                                        <label for="depends-on-job" class="form-label">Dieser Job hängt ab von:</label>
                                        <select id="depends-on-job" class="form-select">
                                            <option value="">-- Job auswählen --</option>
                                            {% for p_dep in potential_dependencies %}
                                                <option value="{{ p_dep.id }}">{{ p_dep.name }} (ID: {{ p_dep.id }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="dependency-type" class="form-label">Abhängigkeitstyp:</label>
                                        <select id="dependency-type" class="form-select">
                                            <option value="finish_to_start">Finish-to-Start</option>
                                            <option value="start_to_start">Start-to-Start</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-plus me-1"></i>Hinzufügen
                                        </button>
                                    </div>
                                </div>
                            </form>
                             <div id="form-feedback" class="mt-3"></div>
                        </div>
                    </div>

                    <h5>Bestehende Abhängigkeiten:</h5>
                    <p>Dieser Job kann erst gestartet werden, wenn die folgenden Jobs abgeschlossen sind:</p>
                    <ul class="list-group" id="dependency-list">
                        {% if job.dependencies %}
                            {% for dep in job.dependencies %}
                                <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ dep.id }}">
                                    <span>
                                        <strong>{{ dep.depends_on.name }}</strong>
                                        <small class="text-muted ms-2">({{ dep.dependency_type.value }})</small>
                                    </span>
                                    <button class="btn btn-sm btn-outline-danger remove-dependency-btn" data-id="{{ dep.id }}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li id="no-dependencies" class="list-group-item text-muted">Keine Abhängigkeiten vorhanden.</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('add-dependency-form');
    const feedbackDiv = document.getElementById('form-feedback');
    const dependencyList = document.getElementById('dependency-list');
    const noDependenciesLi = document.getElementById('no-dependencies');

    // Hinzufügen einer Abhängigkeit
    form.addEventListener('submit', async function (e) {
        e.preventDefault();
        feedbackDiv.innerHTML = ''; 

        const dependsOnId = document.getElementById('depends-on-job').value;
        const depType = document.getElementById('dependency-type').value;

        if (!dependsOnId) {
            showAlert('Bitte wählen Sie einen Job aus.', 'warning');
            return;
        }

        try {
            const response = await fetch("{{ url_for('jobs_bp.add_dependency') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    job_id: {{ job.id }},
                    depends_on_id: dependsOnId,
                    type: depType
                })
            });

            const data = await response.json();

            if (data.success) {
                showAlert('Abhängigkeit erfolgreich hinzugefügt.', 'success');
                addDependencyToList(data.dependency);
                form.reset();
            } else {
                showAlert(`Fehler: ${data.error || 'Unbekannter Fehler'}`, 'danger');
            }
        } catch (error) {
            console.error('Fetch-Fehler:', error);
            showAlert('Ein Kommunikationsfehler ist aufgetreten. Prüfen Sie die Browser-Konsole.', 'danger');
        }
    });

    // Entfernen einer Abhängigkeit
    dependencyList.addEventListener('click', async function(e) {
        if (e.target.closest('.remove-dependency-btn')) {
            const button = e.target.closest('.remove-dependency-btn');
            const dependencyId = button.dataset.id;
            
            if (confirm('Möchten Sie diese Abhängigkeit wirklich entfernen?')) {
                try {
                    const response = await fetch(`/dependencies/remove/${dependencyId}`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token() }}'
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        showAlert('Abhängigkeit entfernt.', 'success');
                        button.closest('li').remove();
                        checkIfListIsEmpty();
                    } else {
                        showAlert(`Fehler: ${data.error || 'Unbekannter Fehler'}`, 'danger');
                    }
                } catch (error) {
                     console.error('Fetch-Fehler:', error);
                     showAlert('Ein Kommunikationsfehler ist aufgetreten.', 'danger');
                }
            }
        }
    });

    function addDependencyToList(dependency) {
        if (noDependenciesLi) {
            noDependenciesLi.remove();
        }

        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.dataset.id = dependency.id;
        li.innerHTML = `
            <span>
                <strong>${dependency.depends_on_name}</strong>
                <small class="text-muted ms-2">(${dependency.type})</small>
            </span>
            <button class="btn btn-sm btn-outline-danger remove-dependency-btn" data-id="${dependency.id}">
                <i class="fas fa-trash-alt"></i>
            </button>
        `;
        dependencyList.appendChild(li);
    }
    
    function checkIfListIsEmpty() {
        if (dependencyList.children.length === 0) {
             const li = document.createElement('li');
             li.id = 'no-dependencies';
             li.className = 'list-group-item text-muted';
             li.textContent = 'Keine Abhängigkeiten vorhanden.';
             dependencyList.appendChild(li);
        }
    }

    function showAlert(message, category) {
        feedbackDiv.innerHTML = `<div class="alert alert-${category}" role="alert">${message}</div>`;
    }
});
</script>
{% endblock %}